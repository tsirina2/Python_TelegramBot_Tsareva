# Проект: разработайте Telegram-бот с функцией календаря, часть 1
<aside>
⚡Этот проект поможет закрепить навыки, которые вы получили по мере прохождения курса. Вы напишете Telegram-бот с функцией календаря, который положите в портфолио. Проект состоит из двух частей. Выполните первую часть в конце модуля «Потоки, процессы и асинхронность», а вторую — в конце модуля «Подготовка к запуску».
</aside>

## Как выполнить проект
1. Скачайте код приложения для заметок из [этой ветки](https://github.com/EdusonPython/Python-Projects/tree/telegram-bot-part1).
2. Прочитайте и выполните задания первой части проекта по порядку. При необходимости пользуйтесь подсказками. Нажмите на треугольник рядом со словом «Подсказка», чтобы раскрыть ее.
3. Если у вас возникнут трудности, обратитесь к урокам, в которых разбирается тема. Для первой части проекта вам понадобятся лекции из модулей «Углубленное программирование», «Основы объектно-ориентированного программирования», «Качественный код», «Работа с базами данных» и «Потоки, процессы и асинхронность».
4. Обратитесь в поддержку, если у вас возникнут вопросы по заданию.

## Как сдать проект через Github
1. Создайте репозиторий с названием: **“Python_TelegramBot_Familiya”**. Вместо Familiya напишите свою фамилию латиницей.
2. Добавьте в репозиторий файл Readme. Заполните его по шаблону:

    > Проект: Telegram-бот с функцией календаря <br>
    > Имя Фамилия — укажите свое имя и фамилию <br>
    > логин на GitHub — укажите имя пользователя (логин) на GitHub <br>
    > e-mail — укажите свой e-mail
4. Создайте новую ветку для проекта в репозитории. В названии ветки должно быть название проекта и номер части. Для первой части это может быть, например: **“bot-part1”** или **“telegram-bot-part1”**.
5. Сделайте финальный коммит кода в ветке задания.
9. Сделайте `pull request` из ветки с заданием в основную ветку проекта `main`, затем сделайте слияние `merge` веток.

<p><aside>
⚡Отправьте проект на код-ревью после того, как выполните **вторую часть**. После разработки первой части Telegram-бота, сделайте финальный коммит в репозиторий и сохраните результат своей работы. Во второй части проекта выполните его до конца и отправьте на код-ревью.
</aside></p>

## Задание №1. Подготовьте код приложения для заметок, чтобы перенести его в Telegram-бот
Прежде чем создать бота, скачайте код приложения для заметок из [этой ветки](https://github.com/EdusonPython/Python-Projects/tree/telegram-bot-part1). На первых этапах работы с ботом добавьте в него функцию заметок, которую разработали ранее. Добавьте функцию календаря позже в соотвествии с последовательностью заданий. 

## Задание №2. Подключите бота к Telegram
Используйте Telegram API, чтобы создать бота в Telegram. 

1. Сделайте запрос в **BotFather** в Telegram, чтобы создать нового бота. Для этого введите в него команду `/newbot` и следуйте инструкциям. Вы получите уникальный токен API для бота.

2. Вынесите API_TOKEN в отдельный файл `secrets.py`, который импортируется в боте.
Добавьте `secrets.py` в `.gitignore`, чтобы этот файл случайно не попал на GitHub.

3. Установите библиотеку `python-telegram-bot`. Для этого запустите `pip install python-telegram-bot==13.13`.

4. Импортируйте модуль `telegram` и классы `Updater`, `CommandHandler`, `MessageHandler`, `Filters` в свой код. Для этого введите: 
    
    ```python
    import telegram
    from telegram.ext import Updater, CommandHandler, MessageHandler, Filters
    ```
    
5. Инициализируйте объект `Updater` с помощью токена API:
    
    ```python
    updater = Updater(token="API_TOKEN")
    ```
    
6. Создайте обработчики (handlers) для каждого действия, которое выполняет бот.
   
   <details>
    <summary><strong>Подсказка</strong></summary>
       
   Изучите пример кода обработчика для создания заметок `create_note_handler(update, context)`.
      
    ```python
        # Создать обработчик для создания заметок create_handler
        def create_note_handler(update, context):
            try:
                # Получить текст заметки из сообщения пользователя
                note_text = update.message.text
                # Получить название заметки из сообщения пользователя
                note_name = update.message.chat_id
                # Создать заметку с помощью функции create_note(note_text, note_name)
                create_note(note_text, note_name)
                # Отправить пользователю подтверждение, что заметка создана
                context.bot.send_message(chat_id=update.message.chat_id, text=f"Заметка {note_name} создана.")
            except:
    
                # Отправить пользователю сообщение об ошибке
                context.bot.send_message(chat_id=update.message.chat_id, text="Произошла ошибка.")
    
        # Добавить функцию create_note_handler как CommandHandler для команды /create
        updater.dispatcher.add_handler(CommandHandler('create', create_note_handler))
    ```
  
    </details> 
    
    Заметьте, что обработчики получают ввод пользователя и выдают ему результат работы функций.
    
8. Повторите предыдущий шаг для каждого действия, которое выполняет бот (чтение, редактирование, удаление заметок, отображение всех заметок, отображение всех заметок в отсортированном виде).

9. Запустите приложение. Для этого введите команду: 
    
    ```python
    updater.start_polling()
    ```
## Задание №3. Добавьте в приложение класс `calendar`
1. Добавьте в приложение класс `Calendar` который будет содержать методы для создания, чтения, редактирования и удаления событий, а также отображения всех событий. Для работы с календарем вам потребуются библиотеки `os` и `datetime`. Импортируйте их в начале кода.
   <details>
    <summary><strong>Подсказка</strong></summary>
       
   Изучите пример кода, который создает класс `Calendar` и его метод `create_event(self, event_name, event_date, event_time, event_details)`.
      
    ```python
        # Создать класс Calendar
        class Calendar:
            def __init__(self):
                self.events = {}
        
        # Создать метод create_event
            def create_event(self, event_name, event_date, event_time, event_details):
                event_id = len(self.events) + 1
                event = {
                    "id": event_id,
                    "name": event_name,
                    "date": event_date,
                    "time": event_time,
                    "details": event_details
                }
                self.events[event_id] = event
                return event_id
    ```
  
    </details> 
    Аналогично добавьте методы для остальных операций с событиями.
    
2. Добавьте и зарегистрируйте обработчики команд для создания, чтения, редактирования и удаления событий, а также отображения всех событий.
   <details>
    <summary><strong>Подсказка</strong></summary>
       
   Изучите пример кода, который создает обработчик для создания событий `create_event_handler(update, context)`.
      
    ```python
        # Зададим глобально доступный объект календаря
        calendar = Calendar()
        
        # Создать обработчик для создания событий 
        def event_create_handler(update, context):
            try:
                # Взять данные о событии из сообщения пользователя
                event_name = update.message.text[14:]
                event_date = "2023-03-14"
                event_time = "14:00"
                event_details = "Описание события"
        
                # Создать событие с помощью метода create_event класса Calendar
                event_id = calendar.create_event(event_name, event_date, event_time, event_details)
        
                # Отправить пользователю подтверждение
                context.bot.send_message(chat_id=update.message.chat_id, text=f"Событие {event_name} создано и имеет номер {event_id}.")
            except:
                # Отправить пользователю сообщение об ошибке
                context.bot.send_message(chat_id=update.message.chat_id, text="При создании события произошла ошибка.")
        
        # Зарегистрировать обработчик, чтобы он вызывался по команде /create_event
        updater.dispatcher.add_handler(CommandHandler('create_event', event_create_handler))
    ```
  
    </details> 

3. Затем включите этот класс в основную функцию приложения (функция `main()`), чтобы дать пользователю возможность создавать, читать, редактировать и удалять события, а также отображать весь список событий.

## Задание №4. Оставьте в приложении только функцию календаря
Проведите рефакторинг кода: уберите весь лишний код, который не нужен для поддержки функции календаря. 
<details>
    <summary><strong>Подсказка</strong></summary>

   К лишнему коду относятся:
   1. Неактивный код, который запрашивает ввод с клавиатуры, если вы не удалили его в задании №2.
   2. Код, который отвечает за работу с заметками:
      - функции `create_note`, `read_note`, `edit_note`, `delete_note`, `display_notes`, `display_sorted_notes`;
      - обработчики `create_note_handler`, `read_note_handler`, `edit_note_handler`, `delete_note_handler`, `display_notes_handler`, `display_sorted_notes_handler`;
      - части основной функции приложения `main`, которые их вызвают.
    
</details> 

## Задание №5. Интегрируйте бота с базой данных PostgreSQL и организуйте хранение событий в базе данных вместо файлов
1. Установите PostgreSQL на свой компьютер. Для этого скачайте дистрибутив для вашей операционной системы с официального сайта https://www.postgresql.org/download/ и выполните процесс установки. Также вы можете воспользоваться пакетным менеджером вашей операционной системы для установки PostgreSQL из командной строки. Например, для Ubuntu и Debian это пакетный менеджер APT, а для Mac OS — Homebrew.
2. Запустите PostgreSQL. Запуск различается в зависимости от операционной системы.
   <details>
    <summary><strong>Подсказка: как запустить PostgreSQL на Windows</strong></summary>
       
   - Откройте командную строку из аккаунта администратора.
   - Назначьте директорию, в которой установлен PostgreSQL, рабочей директорией. Например, если PostgreSQL установлен в `C:\Program Files\PostgreSQL\13\bin`, введите команду:

     ```python
        cd: "C:\Program Files\PostgreSQL\13\bin"
     ```
    
   - Введите команду:
     
     ```python
        pg_ctl.exe start -D "C:\Program Files\PostgreSQL\13\data"
     ```

     где `13` — номер установленной версии PostgreSQL. Это запустит сервер PostgreSQL.

   - Инициализируйте директорию баз данных на локальном компьютере. Для этого введите команду:

     ```python
        initdb -D <data_directory>
     ```

     где `<data_directory>` — путь к директории, в которой будут храниться базы данных. Замените его на путь к нужной директории.
  
    </details> 
    
    <details>
    <summary><strong>Подсказка: как запустить PostgreSQL на Linux</strong></summary>
       
   - Откройте терминал из аккаунта администратора.
   - Введите команду:

     ```python
        sudo service postgresql start
     ```
    
   - Инициализируйте директорию баз данных на локальном компьютере. Для этого введите команду:
     
     ```python
        $ initdb -D <data_directory>
     ```

     где `<data_directory>` — путь к директории, в которой будут храниться базы данных. Замените его на путь к нужной директории.

    </details>

    <details>
    <summary><strong>Подсказка: как запустить PostgreSQL на macOS</strong></summary>
       
   - Откройте терминал из аккаунта администратора.
   - Введите команду:

     ```python
        pg_ctl -D /usr/local/var/postgres start
     ```
    
   - Выберите директорию, где будут храниться базы данных. Для этого введите команду:
     
     ```python
        cd <data_directory>
     ```

     где `<data_directory>` — путь к директории, в которой будут храниться базы данных. Замените его на путь к нужной вам директории.
     
   - Инициализируйте директорию, где будут храниться базы данных. Для этого введите команду:

     ```python
        initdb pgdata
     ```

    </details>

3. Создайте новую базу данных.
   
   <details>
    <summary><strong>Подсказка: как создать базу данных</strong></summary>
       
   - Запустите в командной строке или терминале интерфейс PostgreSQL как пользователь по умолчанию. Для этого введите команду:

     ```python
        psql -U postgres
     ```
    
   - Создайте базу данных. Для этого введите команду: 
     
     ```python
        CREATE DATABASE <database_name>
     ```

     где замените `<database_name>` на имя базы данных, которую вы создаете.

   - Выберете базу данных, которую вы только что создали. Для этого введите команду:

     ```python
        \c <database_name>
     ```

   - Создайте логин и пароль для базы данных. Для этого введите команду:

     ```python
        CREATE USER <username> WITH PASSWORD <password>
     ```

     где замените `<username>` и `<password>` на ваши логин и пароль.

   - Дайте пользователю с этим логином права доступа. Для этого введите команду:

     ```python
        GRANT ALL PRIVILEGES ON DATABASE <database_name> TO <username>
     ```

     где замените `<database_name>` и `<username>` на ваши имя базы данных и логин.

   - Завершите использование командной строки в режиме консоли для PostgreSQL. Для этого введите команду:

     ```python
        \q
     ```

    </details>

4. Установите библиотеку `psycopg2` для Python, которая представляет собой адаптер PostgreSQL для Python. Для этого введите команду: 
    
    ```python
    pip install psycopg2
    ```
    
5. Подключитесь к базе данных. Для этого используйте следующий код:
    
    ```python
    import psycopg2
    conn = psycopg2.connect(
        host=<localhost>,
        database=<database_name>,
        user=<username>,
        password=<password>
    )
    ```
    
    Замените `<localhost>`, `<database_name>`, `<username>`, `<password>` на адрес хоста, имя базы данных, логин и пароль соответственно.
    
6. Создайте в базе данных таблицу для хранения событий. В таблице должны быть столбцы для названия, даты и времени события.
    
    ```python
    cursor = conn.cursor()
    cursor.execute("""
    CREATE TABLE events (
        id serial PRIMARY KEY,
        name text NOT NULL,
        date date NOT NULL,
        time time NOT NULL
    );
    """)
    conn.commit()
    ```
    
7. Измените класс `Calendar` и его методы в коде вашего бота, чтобы использовать базу данных вместо списка Python. Для этого измените: 
    - метод  `create_event(self, event_name, event_date, event_time, event_details)`, чтобы он вставлял новую строку в таблицу `events` вместо добавления события в список событий;
    - методы `read_event(self, event_name)` и `display_events(self)`, чтобы они отображали строки таблицы `events` вместо извлечения элементов списка событий;
    - метод `edit_event(self, event_name, new_date=None, new_description=None)`, чтобы он изменял строки таблицы `events` вместо элементов списка событий;
    - метод `delete_event(self, event_name)`, чтобы он удалял строки таблицы `events` вместо элементов списка событий.
      
8. Создайте экземпляр класса `Calendar` и передайте ему объект `conn` при создании экземпляра. Для этого введите:
    
    ```python
    calendar = Calendar(conn)
    ```

## Задание №6. Измените код бота-календаря так, чтобы он стал многопользовательским
1. **Предусмотрите хранение информации о пользователе.** 
   Сохраняйте  информацию о каждом пользователе (например, его идентификатор Telegram) в базе данных. Вы можете добавить новый столбец в таблицу «события» для хранения идентификатора пользователя, который создал события.

3. **Предусмотрите обработку календарей нескольких пользователей.**
   Измените код бота, чтобы он обрабатывал нескольких пользователей и их события. Вы можете сделать это с помошью идентификаторов пользователей в Telegram, чтобы программа понимала, какие события принадлежат каждому пользователю. Например, когда пользователь хочет создать событие, вы можете получить события из базы данных на основе его идентификатора и отобразить только его события.

5. **Предусмотрите работу с учетными записями пользователей.**
   Дайте пользователям возможность создавать свои учетные записи в боте. Вы можете сделать это, добавив новую команду для регистрации пользователями своей учетной записи, например, `/register`.

7. **Отслеживайте состояние пользователя**.
   Например, отслеживайте, создает ли пользователь событие, просматривает ли он события и т. д., чтобы бот знал, что делать, когда пользователь дает ему команду.
